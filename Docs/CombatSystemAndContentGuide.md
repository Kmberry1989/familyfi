# Combat System and Content Authoring Guide

## Combat Mechanics Overview
- **Fighter lifecycle and ticks:** Fighters initialize their physics body, stance controller, frame tracker, variable set, and optional AI brain before being positioned at starting coordinates and placed into their neutral animation state. Each frame they run a three-phase loop (`PreTick`, `Tick`, `LateTick`) that updates timers, physics, and animation state transitions in order.【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L95-L238】
- **Timers and stun:** Hit stop, hit stun, move buffering, push forces, and bounce windows are all governed by per-fighter `FrameTimer` instances. Timers advance during `PreTick` unless hit stop is active; stun decay and state transitions are reset when the fighter leaves blocking or hit reaction states.【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L13-L205】【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L285-L300】
- **Side and orientation handling:** Fighters track whether they are on the left side of the screen and flip their `PlayerSide` when allowed, auto-turning only during movement states and while grounded to avoid mid-air reorientation during attacks.【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L132-L155】
- **Pushback and bounces:** Push forces apply fixed velocities and optional gravity for a set duration, clearing inertia when the timer ends. Separate horizontal and vertical bounce timers trigger rebound states when the fighter hits walls or the ground, and buffers are cleared once the bounce windows expire.【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L301-L381】
- **State transitions and checks:** During `Tick` the fighter applies throw pivot logic for tethered states, otherwise runs physics or pushback updates before evaluating stance move availability. In `LateTick` the system updates frame properties, transitions, animation events, hitboxes, and damage scaling, ensuring frame data tracking stays in sync with physics and animation.【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L221-L265】

## AI Behavior Configuration
- **Brain setup:** Each fighter can reference an optional `AIBrain` that selects behavior profiles based on the match difficulty and exposes arrays of AI actions plus special-case actions for blocking, recovery, and throw escape. The brain seeds decision timers and holds runtime state for command execution and defensive flags.【F:Scripts/SakugaEngine/Components/AIBrain.cs†L10-L69】
- **Behavior profiles:** Difficulty-specific `AIBehavior` resources define decision cadence when idle or busy, input randomness windows, blocking/teching rates, prediction quality, and a low-health threshold that shifts the bot into defensive mode. They also contain action packs for different engagement ranges (near, mid, far, distant) to drive move selection.【F:Scripts/SakugaEngine/Resources/AI/AIBehavior.cs†L9-L35】
- **Decision flow:** On each selection tick the brain aborts if a round has ended, resets when the fighter is busy beyond certain state types, and prioritizes proximity blocking or tech attempts before choosing new commands. Randomized thresholds from the active behavior profile determine when to advance decisions and how long to wait between simulated inputs.【F:Scripts/SakugaEngine/Components/AIBrain.cs†L100-L205】

## Content Requirements
- **Fighters:** Playable characters are defined by `FighterElement` entries containing a fighter scene and a `FighterProfile` with display names, render/portrait art, and default stage/BGM indices for auto-selection. Scenes are expected to export physics/inputs/animation/stance components plus optional SFX, voice, spawnable, and VFX lists inherited from `SakugaActor`.【F:Scripts/SakugaEngine/Resources/FighterElement.cs†L6-L11】【F:Scripts/SakugaEngine/Resources/FighterProfile.cs†L6-L15】【F:Scripts/SakugaEngine/Components/SakugaActor.cs†L9-L25】
- **Stages:** Each stage entry provides a `PackedScene`, user-facing name, and thumbnail via `StageElement`, aggregated inside a `StageList` used by selection screens and the game manager when instantiating stages.【F:Scripts/SakugaEngine/Resources/StageElement.cs†L6-L12】【F:Scripts/SakugaEngine/Resources/StageList.cs†L6-L10】
- **Background music:** BGMs are stored in `BGMElement` entries with a song name and audio clip and are collected in `BGMList`. The game manager swaps the selected clip into the shared `AudioStreamPlayer` before playback if available.【F:Scripts/SakugaEngine/Resources/BGMElement.cs†L6-L11】【F:Scripts/SakugaEngine/Resources/BGMList.cs†L6-L9】【F:Scripts/SakugaEngine/Game/GameManager.cs†L14-L80】

## Pipeline for Adding New Stages
1. Create a stage scene that implements the desired environment (place it anywhere, e.g., `Stages/`). Use optional `SpawnMarkers/LeftSpawn` and `SpawnMarkers/RightSpawn` nodes to override default spawn coordinates read by the game manager.【F:Scripts/SakugaEngine/Game/GameManager.cs†L207-L239】
2. Add a new `StageElement` entry to the project’s `StageList` resource (e.g., `StageSelect.tres`), referencing the stage `PackedScene`, display name, and thumbnail for UI usage.【F:Scripts/SakugaEngine/Resources/StageElement.cs†L6-L12】【F:Scripts/SakugaEngine/Resources/StageList.cs†L6-L10】
3. Ensure the selection UI and `GameManager` consume the updated list; the manager uses the `selectedStage` index to instantiate the scene during setup, falling back to index `0` if the index is invalid.【F:Scripts/SakugaEngine/Game/GameManager.cs†L15-L218】

## Pipeline for Adding Character Animations and Moves
1. Define or update a fighter’s `FighterStance` resource to list available moves and associated hit reaction states, including default neutral, blocking, throw escape, and recovery state indices for ground/air contexts.【F:Scripts/SakugaEngine/Resources/FighterStance.cs†L9-L31】
2. For each new move, create a `MoveSettings` entry specifying the animation state ID, input sequence (`MotionInputs`), side-change rules, resource costs (super gauge/health), cancel routes, sequence requirements, and move end conditions. Set `UseOnGround`/`UseOnAir` to control availability and include optional super flash, priority, and buffer flags for responsiveness.【F:Scripts/SakugaEngine/Resources/MoveSettings.cs†L5-L38】
3. Hook the move’s animation into the fighter’s animation state machine and frame data so the tick loop can process transitions, animation events, and hitbox updates during `LateTick`. Spawnables/VFX referenced by the move should be instantiated through the fighter’s lists during initialization to ensure they are present at runtime.【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L95-L205】【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L59-L93】

## Integrating Additional Features
- **AI extensions:** Add new difficulty levels or behavior variations by authoring additional `AIBehavior` resources and exposing them on `AIBrain`. Use the existing decision cadence and blocking/teching hooks to thread new defensive/offensive heuristics.【F:Scripts/SakugaEngine/Components/AIBrain.cs†L18-L205】【F:Scripts/SakugaEngine/Resources/AI/AIBehavior.cs†L9-L35】
- **Content tying:** The `GameManager` wires fighters, stages, and BGMs together via exported lists. To introduce new select-screen options or matchmaking rules, update the relevant list resources and ensure indices (`selectedStage`, `selectedBGM`, character indices) are set before `Setup()` runs since it instantiates the stage and fighters and seeds HUD/physics state from those selections.【F:Scripts/SakugaEngine/Game/GameManager.cs†L14-L188】
- **Combat system hooks:** Features like custom pushback types, new bounce reactions, or additional stun states can build on the existing timer-driven push and bounce logic in `SakugaFighter`. The structure separates `PreTick` timing, `Tick` physics/decision handling, and `LateTick` animation/hitbox updates, providing insertion points for new mechanics without breaking frame order.【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L190-L265】【F:Scripts/SakugaEngine/Components/SakugaFighter.cs†L301-L381】
